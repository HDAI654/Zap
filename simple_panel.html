<!DOCTYPE html>
<html lang="fa">
  <head>
    <meta charset="UTF-8" />
    <title>Login / Register / Add Table / Voice Recorder</title>
  </head>
  <body>
    <h2>Register</h2>
    <form id="registerForm">
      <input type="text" name="email" placeholder="Email" required /><br />
      <input
        type="text"
        name="username"
        placeholder="Username"
        required
      /><br />
      <input
        type="password"
        name="password"
        placeholder="Password"
        required
      /><br />
      <button type="submit">Register</button>
    </form>

    <h2>Login</h2>
    <form id="loginForm">
      <input type="text" name="email" placeholder="Email" required /><br />
      <input
        type="password"
        name="password"
        placeholder="Password"
        required
      /><br />
      <button type="submit">Login</button>
    </form>

    <h2>Add Table</h2>
    <form id="addTableForm">
      <input type="text" name="name" placeholder="Table Name" required /><br />
      <textarea
        name="data"
        placeholder='Table Data as JSON, e.g. {"key":"value"}'
        required
        rows="5"
        cols="30"
      ></textarea
      ><br />
      <button type="submit">Add Table</button>
    </form>

    <h2>User Tables</h2>
    <button id="loadTables">Load My Table Names</button>
    <ul id="tablesList"></ul>

    <h2>Get Table Data by ID</h2>
    <form id="getTableForm">
      <input
        type="number"
        name="tableId"
        placeholder="Table ID"
        required
      /><br />
      <button type="submit">Get Table Data</button>
    </form>
    <pre id="tableDataDisplay"></pre>

    <hr />

    <h2>Voice Recorder & Transcriber</h2>
    <button id="startBtn">🎙️ ضبط صدا</button>
    <button id="stopBtn">🛑 توقف و ارسال</button>
    <p>📝 متن: <span id="transcribedText"></span></p>

    <script>
      // Register handler
      document
        .getElementById("registerForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const body = Object.fromEntries(formData.entries());

          try {
            const res = await fetch(
              "http://localhost:8000/api/v1/auth/register",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body),
                credentials: "include",
              }
            );
            const data = await res.json();
            console.log("Register response:", data);
            alert("Register response: " + JSON.stringify(data));
          } catch (error) {
            alert("Error during registration: " + error.message);
          }
        });

      // Login handler
      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const body = Object.fromEntries(formData.entries());

          try {
            const res = await fetch("http://localhost:8000/api/v1/auth/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body),
              credentials: "include",
            });
            const data = await res.json();
            console.log("Login response:", data);
            alert("Login response: " + JSON.stringify(data));
          } catch (error) {
            alert("Error during login: " + error.message);
          }
        });

      // Add Table handler
      document
        .getElementById("addTableForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const tableName = formData.get("name");
          const tableDataRaw = formData.get("data");

          let tableData;
          try {
            tableData = JSON.parse(tableDataRaw);
          } catch (error) {
            alert("Invalid JSON in table data!");
            return;
          }

          const body = {
            name: tableName,
            data: tableData,
          };

          try {
            const res = await fetch(
              "http://localhost:8000/api/v1/user/add-table/",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body),
                credentials: "include",
              }
            );

            if (res.ok) {
              const data = await res.json();
              console.log("Add table response:", data);
              alert("Table added successfully! ID: " + data.id);
            } else {
              const err = await res.json();
              console.error("Add table error:", err);
              alert("Error adding table: " + JSON.stringify(err));
            }
          } catch (error) {
            alert("Error adding table: " + error.message);
          }
        });

      // Load user's table names
      document
        .getElementById("loadTables")
        .addEventListener("click", async () => {
          try {
            const res = await fetch(
              "http://localhost:8000/api/v1/user/tables-names",
              {
                method: "GET",
                credentials: "include",
              }
            );

            if (res.ok) {
              const data = await res.json();
              const list = document.getElementById("tablesList");
              list.innerHTML = "";
              data.tables.forEach((t) => {
                const li = document.createElement("li");
                li.textContent = `ID: ${t.id}, Name: ${t.name}`;
                list.appendChild(li);
              });
            } else {
              alert("Failed to load table names.");
            }
          } catch (error) {
            alert("Error loading tables: " + error.message);
          }
        });

      // Get table data by ID
      document
        .getElementById("getTableForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const tableId = formData.get("tableId");

          const display = document.getElementById("tableDataDisplay");

          try {
            const res = await fetch(
              `http://localhost:8000/api/v1/user/tables/${tableId}`,
              {
                method: "GET",
                credentials: "include",
              }
            );

            if (res.ok) {
              const data = await res.json();
              display.textContent = JSON.stringify(data.table, null, 2);
            } else {
              display.textContent = "Table not found or error occurred.";
            }
          } catch (error) {
            display.textContent = "Error fetching table: " + error.message;
          }
        });

      // Voice recorder and transcriber
      let mediaRecorder = null;
      let chunks = [];

      document
        .getElementById("startBtn")
        .addEventListener("click", async () => {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              audio: true,
            });
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];

            mediaRecorder.ondataavailable = (e) => {
              chunks.push(e.data);
            };

            mediaRecorder.onstop = async () => {
              const blob = new Blob(chunks, { type: "audio/wav" });
              const formData = new FormData();
              formData.append("audio", blob, "voice.wav");

              try {
                const response = await fetch(
                  "http://localhost:5000/transcribe",
                  {
                    method: "POST",
                    body: formData,
                  }
                );
                const data = await response.json();
                document.getElementById("transcribedText").textContent =
                  data.text || "";
              } catch (error) {
                alert("خطا در ارسال صدا به سرور: " + error.message);
              }
            };

            mediaRecorder.start();
          } catch (err) {
            alert("دسترسی به میکروفون امکان‌پذیر نیست: " + err.message);
          }
        });

      document.getElementById("stopBtn").addEventListener("click", () => {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
        }
      });
    </script>
  </body>
</html>
