<!DOCTYPE html>
<html lang="en" dir="rtl" data-bs-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <title>Voice Recorder & Tables</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css"
      rel="stylesheet"
    />
  </head>
  <body dir="ltr">
    <div class="container py-5">
      <div id="accordion">
        <!-- Register -->
        <div class="card">
          <div class="card-header" id="headingRegister">
            <h5 class="mb-0">
              <button
                class="btn btn-link"
                data-bs-toggle="collapse"
                data-bs-target="#collapseRegister"
                aria-expanded="true"
                aria-controls="collapseRegister"
              >
                Register
              </button>
            </h5>
          </div>
          <div
            id="collapseRegister"
            class="collapse"
            aria-labelledby="headingRegister"
            data-bs-parent="#accordion"
          >
            <div class="card-body">
              <form id="registerForm" class="mb-3">
                <div class="mb-3">
                  <input
                    type="email"
                    name="email"
                    placeholder="Email"
                    required
                    class="form-control"
                  />
                </div>
                <div class="mb-3">
                  <input
                    type="text"
                    name="username"
                    placeholder="Username"
                    required
                    class="form-control"
                  />
                </div>
                <div class="mb-3">
                  <input
                    type="password"
                    name="password"
                    placeholder="Password"
                    required
                    class="form-control"
                  />
                </div>
                <button type="submit" class="btn btn-primary w-100">
                  Register
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Login -->
        <div class="card">
          <div class="card-header" id="headingLogin">
            <h5 class="mb-0">
              <button
                class="btn btn-link collapsed"
                data-bs-toggle="collapse"
                data-bs-target="#collapseLogin"
                aria-expanded="false"
                aria-controls="collapseLogin"
              >
                Login
              </button>
            </h5>
          </div>
          <div
            id="collapseLogin"
            class="collapse"
            aria-labelledby="headingLogin"
            data-bs-parent="#accordion"
          >
            <div class="card-body">
              <form id="loginForm" class="mb-3">
                <div class="mb-3">
                  <input
                    type="email"
                    name="email"
                    placeholder="Email"
                    required
                    class="form-control"
                  />
                </div>
                <div class="mb-3">
                  <input
                    type="password"
                    name="password"
                    placeholder="Password"
                    required
                    class="form-control"
                  />
                </div>
                <button type="submit" class="btn btn-success w-100">
                  Login
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Add Table -->
        <div class="card">
          <div class="card-header" id="headingAddTable">
            <h5 class="mb-0">
              <button
                class="btn btn-link collapsed"
                data-bs-toggle="collapse"
                data-bs-target="#collapseAddTable"
                aria-expanded="false"
                aria-controls="collapseAddTable"
              >
                Add Table
              </button>
            </h5>
          </div>
          <div
            id="collapseAddTable"
            class="collapse"
            aria-labelledby="headingAddTable"
            data-bs-parent="#accordion"
          >
            <div class="card-body">
              <form id="addTableForm" class="mb-3">
                <div class="mb-3">
                  <input
                    type="text"
                    name="name"
                    placeholder="Table Name"
                    required
                    class="form-control"
                  />
                </div>
                <div class="mb-3">
                  <textarea
                    name="data"
                    placeholder='Table Data as JSON, e.g. {"key":"value"}'
                    required
                    rows="5"
                    class="form-control"
                  ></textarea>
                </div>
                <button type="submit" class="btn btn-warning w-100 text-white">
                  Add Table
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Load Tables -->
        <div class="card">
          <div class="card-header" id="headingLoadTables">
            <h5 class="mb-0">
              <button
                class="btn btn-link collapsed"
                data-bs-toggle="collapse"
                data-bs-target="#collapseLoadTables"
                aria-expanded="false"
                aria-controls="collapseLoadTables"
              >
                User Tables
              </button>
            </h5>
          </div>
          <div
            id="collapseLoadTables"
            class="collapse"
            aria-labelledby="headingLoadTables"
            data-bs-parent="#accordion"
          >
            <div class="card-body">
              <button id="loadTables" class="btn btn-info mb-3 w-100">
                Load My Table Names
              </button>
              <ul id="tablesList" class="list-group mb-3"></ul>
            </div>
          </div>
        </div>

        <!-- Get Table Data by ID -->
        <div class="card">
          <div class="card-header" id="headingGetTable">
            <h5 class="mb-0">
              <button
                class="btn btn-link collapsed"
                data-bs-toggle="collapse"
                data-bs-target="#collapseGetTable"
                aria-expanded="false"
                aria-controls="collapseGetTable"
              >
                Get Table Data by ID
              </button>
            </h5>
          </div>
          <div
            id="collapseGetTable"
            class="collapse"
            aria-labelledby="headingGetTable"
            data-bs-parent="#accordion"
          >
            <div class="card-body">
              <form id="getTableForm" class="mb-3">
                <div class="mb-3">
                  <input
                    type="number"
                    name="tableId"
                    placeholder="Table ID"
                    required
                    class="form-control"
                  />
                </div>
                <button type="submit" class="btn btn-secondary w-100">
                  Get Table Data
                </button>
              </form>
              <pre
                id="tableDataDisplay"
                class="p-3 border rounded"
                style="min-height: 100px"
              ></pre>
            </div>
          </div>
        </div>

        <!-- Voice Recorder -->
        <div class="card">
          <div class="card-header" id="headingVoice">
            <h5 class="mb-0">
              <button
                class="btn btn-link collapsed"
                data-bs-toggle="collapse"
                data-bs-target="#collapseVoice"
                aria-expanded="false"
                aria-controls="collapseVoice"
              >
                Voice Recorder & Transcriber
              </button>
            </h5>
          </div>
          <div
            id="collapseVoice"
            class="collapse"
            aria-labelledby="headingVoice"
            data-bs-parent="#accordion"
          >
            <div class="card-body">
              <div
                class="mx-auto mb-3 mt-5"
                id="startBtn"
                style="
                  border-radius: 50%;
                  width: 100px;
                  height: 100px;
                  font-size: 40px;
                "
              >
                <div
                  class="h-100 w-100 bg-light"
                  style="border-radius: 50%"
                ></div>
              </div>
              <p id="transcribedText"></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Register handler
      document
        .getElementById("registerForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const body = Object.fromEntries(formData.entries());

          try {
            const res = await fetch(
              "http://localhost:8000/api/v1/auth/register",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body),
                credentials: "include",
              }
            );
            const data = await res.json();
            console.log("Register response:", data);
            alert("Register response: " + JSON.stringify(data));
          } catch (error) {
            alert("Error during registration: " + error.message);
          }
        });

      // Login handler
      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const body = Object.fromEntries(formData.entries());

          try {
            const res = await fetch("http://localhost:8000/api/v1/auth/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body),
              credentials: "include",
            });
            const data = await res.json();
            console.log("Login response:", data);
            alert("Login response: " + JSON.stringify(data));
          } catch (error) {
            alert("Error during login: " + error.message);
          }
        });

      // Add Table handler
      document
        .getElementById("addTableForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const tableName = formData.get("name");
          const tableDataRaw = formData.get("data");

          let tableData;
          try {
            tableData = JSON.parse(tableDataRaw);
          } catch (error) {
            alert("Invalid JSON in table data!");
            return;
          }

          const body = {
            name: tableName,
            data: tableData,
          };

          try {
            const res = await fetch(
              "http://localhost:8000/api/v1/user/add-table/",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body),
                credentials: "include",
              }
            );

            if (res.ok) {
              const data = await res.json();
              console.log("Add table response:", data);
              alert("Table added successfully! ID: " + data.id);
            } else {
              const err = await res.json();
              console.error("Add table error:", err);
              alert("Error adding table: " + JSON.stringify(err));
            }
          } catch (error) {
            alert("Error adding table: " + error.message);
          }
        });

      // Load user's table names
      document
        .getElementById("loadTables")
        .addEventListener("click", async () => {
          try {
            const res = await fetch(
              "http://localhost:8000/api/v1/user/tables-names",
              {
                method: "GET",
                credentials: "include",
              }
            );

            if (res.ok) {
              const data = await res.json();
              const list = document.getElementById("tablesList");
              list.innerHTML = "";
              data.tables.forEach((t) => {
                const li = document.createElement("li");
                li.textContent = `ID: ${t.id}, Name: ${t.name}`;
                li.classList.add("list-group-item");
                list.appendChild(li);
              });
            } else {
              alert("Failed to load table names.");
            }
          } catch (error) {
            alert("Error loading tables: " + error.message);
          }
        });

      // Get table data by ID
      document
        .getElementById("getTableForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const tableId = formData.get("tableId");

          const display = document.getElementById("tableDataDisplay");

          try {
            const res = await fetch(
              `http://localhost:8000/api/v1/user/tables/${tableId}`,
              {
                method: "GET",
                credentials: "include",
              }
            );

            if (res.ok) {
              const data = await res.json();
              display.textContent = JSON.stringify(data.table, null, 2);
            } else {
              display.textContent = "Table not found or error occurred.";
            }
          } catch (error) {
            display.textContent = "Error fetching table: " + error.message;
          }
        });

      // Voice recorder and transcriber
      async function startRecord() {
        voice_btn.innerHTML = `<div class="spinner-grow text-light text-center" role="status" style="border-radius: 50%;width: 100px;height: 100px;font-size: 40px;"><span class="sr-only"></span></div>`;
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          mediaRecorder = new MediaRecorder(stream);
          chunks = [];

          mediaRecorder.ondataavailable = (e) => {
            chunks.push(e.data);
          };

          mediaRecorder.onstop = async () => {
            voice_btn.innerHTML = `<div class="spinner-border text-light text-center" role="status" style="border-radius: 50%;width: 100px;height: 100px;font-size: 40px;"><span class="sr-only"></span></div>`;
            const blob = new Blob(chunks, { type: "audio/wav" });
            const formData = new FormData();
            formData.append("audio", blob, "voice.wav");

            try {
              const response = await fetch(
                "http://localhost:8000/api/v1/voice/transcribe",
                {
                  method: "POST",
                  body: formData,
                }
              );
              const data = await response.json();
              document.getElementById("transcribedText").textContent = data.text
                ? "Answer: " + data.text
                : "";
              speakText(data.text || "");
            } catch (error) {
              alert("Error sending audio to server: " + error.message);
            } finally {
              voice_btn.innerHTML = `<div class="h-100 w-100 bg-light" style="border-radius: 50%"></div>`;
            }
          };

          mediaRecorder.start();
        } catch (err) {
          alert("Microphone access denied: " + err.message);
        }
        return;
      }

      function stopRecord() {
        voice_btn.innerHTML = `<div class="h-100 w-100 bg-light" style="border-radius: 50%"></div>`;
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
        }
        return;
      }

      let mediaRecorder = null;
      let chunks = [];
      const voice_btn = document.getElementById("startBtn");

      voice_btn.addEventListener("mousedown", startRecord);
      voice_btn.addEventListener("mouseup", stopRecord);

      voice_btn.addEventListener("touchstart", startRecord);
      voice_btn.addEventListener("touchend", stopRecord);

      // text to speech
      function speakText(text) {
        if ("speechSynthesis" in window) {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = "en-US";
          window.speechSynthesis.speak(utterance);
        } else {
          alert("Your browser does not support text-to-speech.");
        }
      }
    </script>
  </body>
</html>
